#!/usr/bin/env bash

# Exit if any subcommand fails
set -e

# Switch to the project directory
cd "$(dirname "$0")"
cd ..
BASEDIR=$(pwd)

if [ -x "/Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool" ]; then
  echo "Exporting design from the Sketch file..."
  /Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool export slices --output=app/images/ app/design/Design.sketch

  echo "Parsing colors..."
  COLORS=$(find app/images/Colors -type f -exec bash -c 'echo "$(echo $0 | sed "s/.*\///g" | sed s/\.svg//g),$(cat $0 | grep -o fill=\"#[^\"]*\" | sed s/fill=//g | sed s/\"//g);"' {} \;)
  COLORS_OBJ=$(node -e "var colorsString = process.argv[1]; var colors = colorsString.replace(/\n/g, '').split(';').map(function(s) { return s && s[0].toLowerCase() + s.slice(1); }).map(function(s) { return s.split(',') }).reduce(function(o, c) { if (c[1]) o[c[0]] = c[1]; return o; }, {}); console.log(JSON.stringify(colors, null, 2));" "$COLORS")
  echo "colors = ${COLORS_OBJ}"
  printf "/**\n * This file is generated by running bin/export-design.\n *\n * @providesModule constants/colors\n */\n\nmodule.exports = %s;\n" "$COLORS_OBJ" > app/constants/colors.js
  echo "Exporting done."
else
  echo "ERROR: Sketch is not installed on this machine, the design can not be exported."
  exit -1
fi

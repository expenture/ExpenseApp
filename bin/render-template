#!/usr/bin/env node
/**
 * render-template - Render a mustache template using application configuration
 * and constants.
 *
 * Usage: render-template source-file
 *
 * The output file will be automatically determined by removing the "template"
 * (or "templates") keyword in the source file path, for instance:
 * app/templates/info.xml -> app/info.xml
 * app/config.template.xml -> app/config.xml
 *
 * Requirements: mustache (npm install mustache)
 */

var Mustache = require('mustache');
var fs = require('fs');

// Build variables
var variables = {};

// load app info from package.json
variables.app = require('../package.json');
variables.app.versionName = variables.app.version;
variables.app.versionCode = variables.app.version.split('.').map((v) => parseInt(v)).reduce((vc, v, i) => (vc + v * Math.pow(10000, 2-i)), 0);

// load configurations from config.js
try {
  variables.config = require('../config.js');
} catch (e) {}

// load app constants from app/constants/*
try {
  fs.readdirSync(__dirname + '/../app/constants').forEach(function(file) {
    variables[file.replace(/\.js$/, '')] = require('../app/constants/' + file);
  });
} catch (e) {}

// Do the render
var templateFileName = process.argv[2];

if (!templateFileName) {
  console.error('Error: Missing template path as the first arg.');
  return -1;
}

var outputFileName = templateFileName.replace(/[\._\-\/]templates?/, '');

if (outputFileName == templateFileName) {
  console.error('Error: The template file path does not contains "template", so we can\'t determine where to place the output file. Please rename the template file or place the template file in a directory named "template".');
  return -1;
}

var templateFile = fs.readFileSync(templateFileName, "utf8");

var outputFile = Mustache.render(templateFile, variables);

if (outputFileName.match(/.xml$/)) {
  outputFile = "<!-- This file is rendered from " + templateFileName + " -->\n" +
               "<!-- !!! DO NOT EDIT THIS FILE DIRECTLY. !!! -->\n" +
               "<!-- You should edit " + templateFileName + " and then run bin/render-templates from the project directory. -->\n\n" +
               outputFile +
               "\n" +
               "<!-- !!! DO NOT EDIT THIS FILE DIRECTLY. !!! -->\n" +
               "<!-- This file is rendered from " + templateFileName + " -->\n" +
               "<!-- You should edit " + templateFileName + " and then run bin/render-templates from the project directory. -->\n";
} else if (outputFileName.match(/.gradle$/)) {
  outputFile = "/**\n * This file is rendered from " + templateFileName + "\n" +
               " *\n" +
               " * !!! DO NOT EDIT THIS FILE DIRECTLY. !!!\n" +
               " *\n" +
               " * You should edit " + templateFileName + "\n" +
               " * and then run bin/render-templates from the project directory.\n" +
               " */\n\n" +
               outputFile +
               "\n" +
               "// !!! DO NOT EDIT THIS FILE DIRECTLY. !!!\n" +
               "// This file is rendered from " + templateFileName + "\n" +
               "// You should edit " + templateFileName + "\n" +
               "// and then run bin/render-templates from the project directory.\n";
}

fs.writeFileSync(outputFileName, outputFile);

console.log("Rendered: ", templateFileName);
